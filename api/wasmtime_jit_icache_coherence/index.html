<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="This crate provides utilities for instruction cache maintenance for JIT authors."><meta name="keywords" content="rust, rustlang, rust-lang, wasmtime_jit_icache_coherence"><title>wasmtime_jit_icache_coherence - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../normalize.css"><link rel="stylesheet" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../ayu.css" disabled><link rel="stylesheet" href="../dark.css" disabled><link rel="stylesheet" href="../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../storage.js"></script><script defer src="../crates.js"></script><script defer src="../main.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../favicon.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../wasmtime_jit_icache_coherence/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../wasmtime_jit_icache_coherence/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Crate wasmtime_jit_icache_coherence</a></h2><div class="sidebar-elems"><div class="block"><ul><li class="version">Version 2.0.0</li><li><a id="all-types" href="all.html">All Items</a></li></ul></div><section><div class="block"><ul><li><a href="#functions">Functions</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../wasmtime_jit_icache_coherence/index.html"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Crate <a class="mod" href="#">wasmtime_jit_icache_coherence</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../src/wasmtime_jit_icache_coherence/lib.rs.html#1-105">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>This crate provides utilities for instruction cache maintenance for JIT authors.</p>
<p>In self modifying codes such as when writing a JIT, special care must be taken when marking the
code as ready for execution. On fully coherent architectures (X86, S390X) the data cache (D-Cache)
and the instruction cache (I-Cache) are always in sync. However this is not guaranteed for all
architectures such as AArch64 where these caches are not coherent with each other.</p>
<p>When writing new code there may be a I-cache entry for that same address which causes the
processor to execute whatever was in the cache instead of the new code.</p>
<p>See the <a href="https://community.arm.com/arm-community-blogs/b/architectures-and-processors-blog/posts/caches-and-self-modifying-code">ARM Community - Caches and Self-Modifying Code</a> blog post that contains a great
explanation of the above. (It references AArch32 but it has a high level overview of this problem).</p>
<h3 id="usage"><a href="#usage">Usage</a></h3>
<p>You should call <a href="fn.clear_cache.html" title="clear_cache">clear_cache</a> on any pages that you write with the new code that you’re intending
to execute. You can do this at any point in the code from the moment that you write the page up to
the moment where the code is executed.</p>
<p>You also need to call <a href="fn.pipeline_flush_mt.html" title="pipeline_flush_mt">pipeline_flush_mt</a> to ensure that there isn’t any invalid instruction currently
in the pipeline if you are running in a multi threaded environment.</p>
<p>For single threaded programs you are free to omit <a href="fn.pipeline_flush_mt.html" title="pipeline_flush_mt">pipeline_flush_mt</a>, otherwise you need to
call both <a href="fn.clear_cache.html" title="clear_cache">clear_cache</a> and <a href="fn.pipeline_flush_mt.html" title="pipeline_flush_mt">pipeline_flush_mt</a> in that order.</p>
<h4 id="example"><a href="#example">Example:</a></h4>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// Invalidate the cache for all the newly written pages where we wrote our new code.
</span><span class="kw">for </span>page <span class="kw">in </span>newly_written_pages {
    clear_cache(page.addr, page.len)<span class="question-mark">?</span>;
}

<span class="comment">// Once those are invalidated we also need to flush the pipeline
</span>pipeline_flush_mt()<span class="question-mark">?</span>;

<span class="comment">// We can now safely execute our new code.
</span>run_code();</code></pre></div>
<div class="example-wrap" style="display:inline-block"><pre class="compile_fail" style="white-space:normal;font:inherit;">
<p><strong>Warning</strong>: In order to correctly use this interface you should always call <a href="fn.clear_cache.html" title="clear_cache">clear_cache</a>.
A followup call to <a href="fn.pipeline_flush_mt.html" title="pipeline_flush_mt">pipeline_flush_mt</a> is required if you are running in a multi-threaded environment.</p>
<p></pre></div></p>
</div></details><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="fn" href="fn.clear_cache.html" title="wasmtime_jit_icache_coherence::clear_cache fn">clear_cache</a><a title="unsafe function" href="#"><sup>⚠</sup></a></div><div class="item-right docblock-short"><p>Flushes the instruction cache for a region of memory.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="fn" href="fn.pipeline_flush_mt.html" title="wasmtime_jit_icache_coherence::pipeline_flush_mt fn">pipeline_flush_mt</a></div><div class="item-right docblock-short"><p>Flushes instructions in the processor pipeline</p>
</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../" data-current-crate="wasmtime_jit_icache_coherence" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0-nightly (78a891d36 2022-09-06)" ></div></body></html>